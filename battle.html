<!DOCTYPE HTML>
<html>
  <head>
    <style>
		body {
		margin: 0px;
		padding: 0px;
		}
		#container {
			margin-left: 20px;
		}
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.5.5.min.js"></script>
    <script defer="defer">
		Array.prototype.remove = function(v){
			delete this[this.indexOf(v)];
		};
		var stage = new Kinetic.Stage({
			container: 'container',
			width: 1024,
			height: 600
		});
		var layer = new Kinetic.Layer();  // Layer to display what's happening
		
		var bullets = [];  // Keep track of the bullets
		var enemies = [];  // Keep track of the enemies
		var enemiesAnim = []; // Keep track of the enemy animations
		var points = 0;

		var messageLayer = new Kinetic.Layer();
		stage.add(messageLayer);
		
		
		var body = new Kinetic.Circle({
			x:stage.getWidth()/2,
			y:stage.getHeight()/2,
			radius:50,
			stroke: 'black',
			strokeWidth: 4
		});

		layer.add(body);
		stage.add(layer);
		var background = new Kinetic.Rect({
			x: 0,
			y: 0,
			width:stage.getWidth(),
			height:stage.getHeight(),stroke: 'black',
			strokeWidth: 1
		});
		layer.add(background);
		
		
		
		
		// Moving animation for body
		var animRight = new Kinetic.Animation(function(frame) {
			if (body.getX() <= stage.getAttr("width") - 80) {
				body.setX(body.getX() + 5);
			}  
		}, layer);
      
		var animUp = new Kinetic.Animation(function(frame) {
			if (body.getY() >= 10) {
				body.setY(body.getY() - 5);
			}

		}, layer);
      
		var animLeft = new Kinetic.Animation(function(frame) {
			if (body.getX() >= 10) {
				body.setX(body.getX() - 5);
			}

		}, layer);
	  
		var animDown = new Kinetic.Animation(function(frame) {
			if (body.getY() <= stage.getAttr("height") - 55) {
			  body.setY(body.getY() + 5);
			}
		}, layer);
		
		// Event for control the body
		window.addEventListener('keydown', function(e) {
			switch (e.keyCode) {
				case 37:
					// Left
					animLeft.start();
					break;
				case 38:
					// Up
					animUp.start();
					break;
				case 39:
					// Right
					animRight.start();
					break;
				case 40:
					// Down
					animDown.start();
					break;
				case 32:
					// Clear all the enemies
					for (var i = 0; i < enemies.length; i++) {
						enemies[i].remove();
					}
					for (var j = 0; j < enemiesAnim.length; j++) {
						enemiesAnim[j].stop();
					}
					break;
			}
		});
      
		window.addEventListener('keyup', function(e) {
			switch (e.keyCode) {
				case 37:
					
					animLeft.stop();
					break;
				case 38:
					animUp.stop();
					break;
				case 39:
					animRight.stop();
					break;
				case 40:
					animDown.stop();
					break;
				case 81:
					break;
			}
		});
		
		function writeMessage(messageLayer, message) {
				var context = messageLayer.getContext();
				messageLayer.clear();
				context.font = '18pt Calibri';
				context.fillStyle = 'black';
				context.fillText(message, 50, 25);  // The position to be displayed on the stage
		};
		
		
		window.setInterval(
			function(){
			var bullet = new Kinetic.Circle({
				x:body.getX(),
				y:body.getY(),
				radius: 5,
				fill: 'blue'
			});
			layer.add(bullet);
			bullets.push(bullet);
			var animbullet = new Kinetic.Animation(function(frame) {
				// Once reaches the bound, remove bullet
				bullet.setY( bullet.getY()-8);
				if (bullet.getY() <= 5) {
					bullets.splice(bullets.indexOf(bullet), 1);
					bullet.remove();
					this.stop();
				}
			}, layer);
			animbullet.start();
		}
		, 150);
		function enermy() {
			// Function for displaying enemy planes
			
			// Get a random position for the plane
			px = Math.floor((Math.random()*800)+1)
			py = 0
			
			// Create an enermy variable with random position
			var enemy = new Kinetic.Circle({
				x: px,
				y: py,
				radius: 5,
				stroke: 'black',
				strokeWidth: 5
			});
			layer.add(enemy); // Add the enemy variable to layer
			enemies.push(enemy);
			var enemyAnim = new Kinetic.Animation(function(frame) {
				// Once reach bound, remove the enemy plane
				if (enemy.getY() >= stage.getAttr("height") - 5){
					enemies.splice(enemies.indexOf(enemy), 1);
					enemy.remove();
					this.stop();
				}
				// Define the collision logic here
				dx = Math.pow((enemy.getX() - body.getX()), 2);
				dy = Math.pow((enemy.getY() - body.getY()), 2);
				distance = Math.sqrt(dx + dy);
				if (distance <= 50) {
					enemies.splice(enemies.indexOf(enemy), 1);
					enemy.remove();
					this.stop();
				}

				for (var i = 0; i < bullets.length; i++) {
					// Get coordinate and distance of bullets and enemies
					x1 = enemy.getX();
					y1 = enemy.getY();
					x2 = bullets[i].getX();
					y2 = bullets[i].getY();
					ddx =Math.pow((x1 - x2), 2);
					ddy = Math.pow((y1 - y2), 2);
					ddistance = Math.sqrt(ddx + ddy);
					if (ddistance <= 20) {
						// Enemy hit by bullets, remove enemy and stop the animation
						enemies.splice(enemies.indexOf(enemy), 1);
						enemy.remove();
						this.stop();
						points += 1;
						writeMessage(messageLayer, points);
					}
				}
				enemy.setY(enemy.getY() + 3);
			}, layer);
			enemyAnim.start();
			enemiesAnim.push(enemyAnim);
		};
		
		function niubi() {
			var angle = 0;
			var bx = 0;
			var by = 0;
			for (var i = 0; i < 36; i++) {
				angle = i * 10;
				bx = 8 * Math.cos(angle * Math.PI / 180);
				by = 8 * Math.sin(angle * Math.PI / 180);

				var bullet = new Kinetic.Circle({
					x:body.getX(),
					y:body.getY(),
					radius: 5,
					fill: 'blue'
				});
				layer.add(bullet);
				bullets.push(bullet);
				var animbullet = new Kinetic.Animation(function(frame) {
					// Once reaches the bound, remove bullet
					bullet.setX(bullet.getX() + bx);
					bullet.setY(bullet.getY() + by);
				}, layer);
				animbullet.start();
			}
		}
		
		setInterval(function(){
			enermy();
		},100);
    </script>
  </body>
</html>
